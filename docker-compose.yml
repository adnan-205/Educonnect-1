version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: educonnect-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password123}
      MONGO_INITDB_DATABASE: ${MONGO_DB_NAME:-educonnect}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongodb-init:/docker-entrypoint-initdb.d
    networks:
      - educonnect-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: educonnect-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-password123}@mongodb:27017/${MONGO_DB_NAME:-educonnect}?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      TRUST_PROXY: "true"
      JITSI_DOMAIN: ${JITSI_DOMAIN:-localhost:8080}
    ports:
      - "5000:5000"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - educonnect-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: educonnect-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:5000/api}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - educonnect-network

  # Jitsi Meet - Self-hosted Video Conferencing
  jitsi-web:
    image: jitsi/web:stable
    container_name: educonnect-jitsi-web
    restart: unless-stopped
    ports:
      - "${JITSI_WEB_PORT:-8443}:443"
      - "${JITSI_WEB_HTTP_PORT:-8080}:80"
    volumes:
      - jitsi-web-config:/config:Z
      - jitsi-web-crontabs:/var/spool/cron/crontabs:Z
      - jitsi-transcripts:/usr/share/jitsi-meet/transcripts:Z
    environment:
      - ENABLE_AUTH=${JITSI_ENABLE_AUTH:-0}
      - ENABLE_GUESTS=${JITSI_ENABLE_GUESTS:-1}
      - ENABLE_LETSENCRYPT=${JITSI_ENABLE_LETSENCRYPT:-0}
      - ENABLE_HTTP_REDIRECT=${JITSI_ENABLE_HTTP_REDIRECT:-1}
      - ENABLE_HSTS=${JITSI_ENABLE_HSTS:-1}
      - ENABLE_XMPP_WEBSOCKET=${JITSI_ENABLE_XMPP_WEBSOCKET:-1}
      - DISABLE_HTTPS=${JITSI_DISABLE_HTTPS:-0}
      - JICOFO_AUTH_USER=${JITSI_JICOFO_AUTH_USER:-focus}
      - LETSENCRYPT_DOMAIN=${JITSI_DOMAIN}
      - LETSENCRYPT_EMAIL=${JITSI_LETSENCRYPT_EMAIL}
      - PUBLIC_URL=${JITSI_PUBLIC_URL:-http://localhost:8080}
      - XMPP_DOMAIN=${JITSI_XMPP_DOMAIN:-localhost}
      - XMPP_AUTH_DOMAIN=${JITSI_XMPP_AUTH_DOMAIN:-auth.localhost}
      - XMPP_BOSH_URL_BASE=${JITSI_XMPP_BOSH_URL_BASE:-http://localhost:8080/http-bind}
      - XMPP_GUEST_DOMAIN=${JITSI_XMPP_GUEST_DOMAIN:-guest.localhost}
      - XMPP_MUC_DOMAIN=${JITSI_XMPP_MUC_DOMAIN:-conference.localhost}
      - XMPP_RECORDER_DOMAIN=${JITSI_XMPP_RECORDER_DOMAIN:-recorder.localhost}
      - TZ=${TZ:-UTC}
    depends_on:
      - jitsi-prosody
    networks:
      - educonnect-network

  jitsi-prosody:
    image: jitsi/prosody:stable
    container_name: educonnect-jitsi-prosody
    restart: unless-stopped
    expose:
      - '5222'
      - '5347'
      - '5280'
    volumes:
      - jitsi-prosody-config:/config:Z
      - jitsi-prosody-plugins:/prosody-plugins-custom:Z
    environment:
      - AUTH_TYPE=${JITSI_AUTH_TYPE:-internal}
      - ENABLE_AUTH=${JITSI_ENABLE_AUTH:-0}
      - ENABLE_GUESTS=${JITSI_ENABLE_GUESTS:-1}
      - ENABLE_LOBBY=${JITSI_ENABLE_LOBBY:-0}
      - ENABLE_XMPP_WEBSOCKET=${JITSI_ENABLE_XMPP_WEBSOCKET:-1}
      - XMPP_DOMAIN=${JITSI_XMPP_DOMAIN:-localhost}
      - XMPP_AUTH_DOMAIN=${JITSI_XMPP_AUTH_DOMAIN:-auth.localhost}
      - XMPP_GUEST_DOMAIN=${JITSI_XMPP_GUEST_DOMAIN:-guest.localhost}
      - XMPP_MUC_DOMAIN=${JITSI_XMPP_MUC_DOMAIN:-conference.localhost}
      - XMPP_INTERNAL_MUC_DOMAIN=${JITSI_XMPP_INTERNAL_MUC_DOMAIN:-internal.auth.localhost}
      - XMPP_RECORDER_DOMAIN=${JITSI_XMPP_RECORDER_DOMAIN:-recorder.localhost}
      - JICOFO_COMPONENT_SECRET=${JITSI_JICOFO_COMPONENT_SECRET:-s3cr3t}
      - JICOFO_AUTH_USER=${JITSI_JICOFO_AUTH_USER:-focus}
      - JICOFO_AUTH_PASSWORD=${JITSI_JICOFO_AUTH_PASSWORD:-passw0rd}
      - JVB_AUTH_USER=${JITSI_JVB_AUTH_USER:-jvb}
      - JVB_AUTH_PASSWORD=${JITSI_JVB_AUTH_PASSWORD:-passw0rd}
      - JIGASI_XMPP_USER=${JITSI_JIGASI_XMPP_USER:-jigasi}
      - JIGASI_XMPP_PASSWORD=${JITSI_JIGASI_XMPP_PASSWORD:-passw0rd}
      - JIBRI_XMPP_USER=${JITSI_JIBRI_XMPP_USER:-jibri}
      - JIBRI_XMPP_PASSWORD=${JITSI_JIBRI_XMPP_PASSWORD:-passw0rd}
      - JIBRI_RECORDER_USER=${JITSI_JIBRI_RECORDER_USER:-recorder}
      - JIBRI_RECORDER_PASSWORD=${JITSI_JIBRI_RECORDER_PASSWORD:-passw0rd}
      - LOG_LEVEL=${JITSI_LOG_LEVEL:-info}
      - TZ=${TZ:-UTC}
    networks:
      educonnect-network:
        aliases:
          - xmpp.localhost

  jitsi-jicofo:
    image: jitsi/jicofo:stable
    container_name: educonnect-jitsi-jicofo
    restart: unless-stopped
    volumes:
      - jitsi-jicofo-config:/config:Z
    environment:
      - ENABLE_AUTH=${JITSI_ENABLE_AUTH:-0}
      - XMPP_DOMAIN=${JITSI_XMPP_DOMAIN:-localhost}
      - XMPP_AUTH_DOMAIN=${JITSI_XMPP_AUTH_DOMAIN:-auth.localhost}
      - XMPP_INTERNAL_MUC_DOMAIN=${JITSI_XMPP_INTERNAL_MUC_DOMAIN:-internal.auth.localhost}
      - XMPP_SERVER=${JITSI_XMPP_SERVER:-jitsi-prosody}
      - JICOFO_COMPONENT_SECRET=${JITSI_JICOFO_COMPONENT_SECRET:-s3cr3t}
      - JICOFO_AUTH_USER=${JITSI_JICOFO_AUTH_USER:-focus}
      - JICOFO_AUTH_PASSWORD=${JITSI_JICOFO_AUTH_PASSWORD:-passw0rd}
      - JVB_BREWERY_MUC=${JITSI_JVB_BREWERY_MUC:-jvbbrewery}
      - JIGASI_BREWERY_MUC=${JITSI_JIGASI_BREWERY_MUC:-jigasibrewery}
      - JIBRI_BREWERY_MUC=${JITSI_JIBRI_BREWERY_MUC:-jibribrewery}
      - JIBRI_PENDING_TIMEOUT=${JITSI_JIBRI_PENDING_TIMEOUT:-90}
      - TZ=${TZ:-UTC}
    depends_on:
      - jitsi-prosody
    networks:
      - educonnect-network

  jitsi-jvb:
    image: jitsi/jvb:stable
    container_name: educonnect-jitsi-jvb
    restart: unless-stopped
    ports:
      - "${JITSI_JVB_PORT:-10000}:10000/udp"
      - "${JITSI_JVB_TCP_PORT:-4443}:4443/tcp"
    volumes:
      - jitsi-jvb-config:/config:Z
    environment:
      - DOCKER_HOST_ADDRESS=${JITSI_DOCKER_HOST_ADDRESS}
      - XMPP_AUTH_DOMAIN=${JITSI_XMPP_AUTH_DOMAIN:-auth.localhost}
      - XMPP_INTERNAL_MUC_DOMAIN=${JITSI_XMPP_INTERNAL_MUC_DOMAIN:-internal.auth.localhost}
      - XMPP_SERVER=${JITSI_XMPP_SERVER:-jitsi-prosody}
      - JVB_AUTH_USER=${JITSI_JVB_AUTH_USER:-jvb}
      - JVB_AUTH_PASSWORD=${JITSI_JVB_AUTH_PASSWORD:-passw0rd}
      - JVB_BREWERY_MUC=${JITSI_JVB_BREWERY_MUC:-jvbbrewery}
      - JVB_PORT=${JITSI_JVB_PORT:-10000}
      - JVB_TCP_HARVESTER_DISABLED=${JITSI_JVB_TCP_HARVESTER_DISABLED:-false}
      - JVB_TCP_PORT=${JITSI_JVB_TCP_PORT:-4443}
      - JVB_TCP_MAPPED_PORT=${JITSI_JVB_TCP_MAPPED_PORT:-4443}
      - JVB_STUN_SERVERS=${JITSI_JVB_STUN_SERVERS:-meet-jit-si-turnrelay.jitsi.net:443}
      - JVB_ENABLE_APIS=${JITSI_JVB_ENABLE_APIS:-rest,xmpp}
      - PUBLIC_URL=${JITSI_PUBLIC_URL:-http://localhost:8080}
      - TZ=${TZ:-UTC}
    depends_on:
      - jitsi-prosody
    networks:
      - educonnect-network

  # Nginx Reverse Proxy (Optional - for production)
  nginx:
    image: nginx:alpine
    container_name: educonnect-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
      - jitsi-web
    networks:
      - educonnect-network

volumes:
  mongodb_data:
    driver: local
  jitsi-prosody-config:
    driver: local
  jitsi-prosody-plugins:
    driver: local
  jitsi-web-config:
    driver: local
  jitsi-jicofo-config:
    driver: local
  jitsi-jvb-config:
    driver: local
  jitsi-web-crontabs:
    driver: local
  jitsi-transcripts:
    driver: local

networks:
  educonnect-network:
    driver: bridge
